#!/usr/bin/env node

/**
 * Automated Release Creator
 * Creates GitHub releases for Container GUI with integration support
 */

const fs = require('fs').promises;
const path = require('path');
const { execSync } = require('child_process');

class ReleaseCreator {
  constructor() {
    this.projectRoot = path.join(__dirname, '..');
    this.logFile = path.join(this.projectRoot, 'logs', 'release.log');
  }

  async log(message) {
    const timestamp = new Date().toISOString();
    const logEntry = `[${timestamp}] ${message}\n`;
    console.log(message);
    
    try {
      await fs.mkdir(path.dirname(this.logFile), { recursive: true });
      await fs.appendFile(this.logFile, logEntry);
    } catch (error) {
      console.error('Failed to write to log file:', error);
    }
  }

  async getCurrentVersion() {
    const packagePath = path.join(this.projectRoot, 'package.json');
    const packageData = JSON.parse(await fs.readFile(packagePath, 'utf-8'));
    return packageData.version;
  }

  async getLatestContainerVersion() {
    try {
      // Fetch the latest Apple Container version from our release state
      const stateFile = path.join(this.projectRoot, '.release-state.json');
      const state = JSON.parse(await fs.readFile(stateFile, 'utf-8'));
      return state.lastProcessedTag || '0.1.0';
    } catch (error) {
      await this.log('âš ï¸ Could not determine latest container version, using default');
      return '0.1.0';
    }
  }

  async generateReleaseNotes() {
    const version = await this.getCurrentVersion();
    const containerVersion = await this.getLatestContainerVersion();
    
    // Read auto-generated release notes if they exist
    const releaseNotesPath = path.join(this.projectRoot, 'RELEASE_NOTES.md');
    let autoGeneratedNotes = '';
    
    try {
      autoGeneratedNotes = await fs.readFile(releaseNotesPath, 'utf-8');
    } catch (error) {
      await this.log('â„¹ï¸ No auto-generated release notes found');
    }
    
    // Read recent changes from git log
    let gitChanges = '';
    try {
      gitChanges = execSync('git log --oneline --max-count=10', {
        cwd: this.projectRoot,
        encoding: 'utf-8'
      });
    } catch (error) {
      await this.log('âš ï¸ Could not read git log');
    }
    
    const releaseNotes = `# Container GUI v${version}

## ðŸŽ‰ Apple Container CLI Integration

This release includes enhanced support for Apple Container CLI ${containerVersion}.

### ðŸ”— Apple Container Repository
- **Repository**: [apple/container](https://github.com/apple/container)
- **Version Supported**: ${containerVersion}
- **Stars**: 15.2k â­
- **Status**: Active development

### âœ¨ What's New

- âœ… **Updated compatibility** with Apple Container CLI ${containerVersion}
- ðŸ”„ **Automatic feature detection** and integration
- ðŸŽ¨ **Enhanced UI** for new container commands
- ðŸš© **New flags support** for advanced container operations
- ðŸ“Š **Improved error handling** and user feedback
- ðŸ”§ **Backend optimizations** for better CLI integration

### ðŸ–¥ï¸ System Requirements

- **macOS 15+** (macOS 26 beta recommended for best compatibility)
- **Apple Silicon Mac** (M1, M2, M3, M4 series)
- **Apple Container CLI** [${containerVersion}](https://github.com/apple/container/releases)
- **Node.js 18+** (for development)

### ðŸ“¦ Installation

1. **Install Apple Container CLI**:
   \`\`\`bash
   # Download from GitHub releases
   # https://github.com/apple/container/releases/tag/${containerVersion}
   
   # Install and start the system
   container system start
   \`\`\`

2. **Install Container GUI**:
   - Download the DMG from the release assets
   - Double-click to mount and drag to Applications
   - Launch from Applications folder

### ðŸ”§ Integration Features

#### Automated Apple Container Monitoring
- ðŸ” **Release Monitoring**: Automatically tracks [apple/container releases](https://github.com/apple/container)
- ðŸ“ **Feature Analysis**: Intelligent parsing of release notes for new commands and flags
- ðŸ”„ **Auto-Integration**: Seamless integration of new CLI features into the GUI
- ðŸ§ª **Testing Pipeline**: Comprehensive testing of new integrations
- ðŸ“¦ **Release Automation**: Automated release creation with proper versioning

#### Smart CLI Integration
- ðŸŽ¯ **Command Mapping**: Dynamic mapping of new container commands to UI components
- ðŸš© **Flag Detection**: Automatic discovery and integration of new command flags
- âš ï¸ **Breaking Change Handling**: Intelligent detection and handling of breaking changes
- ðŸ”„ **Backward Compatibility**: Maintained compatibility with previous container versions

### ðŸŒŸ Key Features

#### Container Management
- ðŸš€ **Run Containers** with comprehensive resource control
- ðŸ—ï¸ **Build Images** with multi-architecture support
- ðŸ“Š **Real-time Logs** with advanced filtering
- ðŸ–¥ï¸ **System Control** and monitoring

#### Apple Container Networking
- ðŸŒ **Dedicated IP Addresses**: Each container gets its own IP
- ðŸ”— **Direct Access**: No port mapping required
- ðŸ·ï¸ **DNS Support**: Access containers via hostname.domain
- ðŸ”’ **Network Isolation**: Secure container communication

#### Developer Experience
- ðŸŽ¨ **Modern UI**: Clean, intuitive interface designed for macOS
- âš¡ **Fast Performance**: Native Tauri/Rust backend
- ðŸ”„ **Live Updates**: Real-time container and system status
- ðŸ“š **Comprehensive Documentation**: In-app help and guides

${autoGeneratedNotes ? `

### ðŸ¤– Auto-Generated Integration Notes

${autoGeneratedNotes}

` : ''}

### ðŸ“ Recent Changes

\`\`\`
${gitChanges}
\`\`\`

### ðŸš€ Getting Started

1. **Install Apple Container CLI** from the [official releases](https://github.com/apple/container/releases)
2. **Start the container system**: \`container system start\`
3. **Launch Container GUI** from Applications
4. **Explore the features** through the intuitive interface

### ðŸ› Known Issues

- Some features require macOS 26 beta for optimal performance
- Network limitations may affect container connectivity on macOS 15

### ðŸ’ Contributing

We welcome contributions! Check out our [GitHub repository](https://github.com/your-repo/container-gui) for:
- ðŸ› Bug reports and feature requests
- ðŸ”§ Code contributions and improvements
- ðŸ“š Documentation enhancements
- ðŸ§ª Testing and feedback

### ðŸ“š Documentation

- **Apple Container Docs**: [apple.github.io/container/documentation](https://apple.github.io/container/documentation/)
- **Container GUI Docs**: Included in the application
- **Troubleshooting Guide**: See TROUBLESHOOTING.md

---

**Full Changelog**: [View on GitHub](https://github.com/your-repo/container-gui/compare/v${this.getPreviousVersion(version)}...v${version})

*This release automatically integrates with Apple Container CLI ${containerVersion} and includes enhanced monitoring and automation capabilities.*`;

    return releaseNotes;
  }

  getPreviousVersion(currentVersion) {
    const parts = currentVersion.split('.').map(Number);
    if (parts[2] > 0) {
      parts[2]--;
    } else if (parts[1] > 0) {
      parts[1]--;
      parts[2] = 9;
    } else if (parts[0] > 0) {
      parts[0]--;
      parts[1] = 9;
      parts[2] = 9;
    }
    return parts.join('.');
  }

  async buildRelease() {
    await this.log('ðŸ”¨ Building release...');
    
    try {
      // Clean and build
      execSync('npm run build', {
        cwd: this.projectRoot,
        stdio: 'inherit'
      });
      
      // Build Tauri release
      execSync('npm run tauri build', {
        cwd: this.projectRoot,
        stdio: 'inherit'
      });
      
      await this.log('âœ… Release build completed');
    } catch (error) {
      throw new Error(`Build failed: ${error.message}`);
    }
  }

  async createGitTag() {
    const version = await this.getCurrentVersion();
    const tagName = `v${version}`;
    
    try {
      // Check if tag already exists
      try {
        execSync(`git rev-parse ${tagName}`, {
          cwd: this.projectRoot,
          stdio: 'pipe'
        });
        await this.log(`âš ï¸ Tag ${tagName} already exists, skipping tag creation`);
        return tagName;
      } catch {
        // Tag doesn't exist, create it
      }
      
      // Create and push tag
      execSync(`git tag -a ${tagName} -m "Release ${tagName}"`, {
        cwd: this.projectRoot,
        stdio: 'inherit'
      });
      
      execSync(`git push origin ${tagName}`, {
        cwd: this.projectRoot,
        stdio: 'inherit'
      });
      
      await this.log(`âœ… Created and pushed tag: ${tagName}`);
      return tagName;
    } catch (error) {
      throw new Error(`Failed to create git tag: ${error.message}`);
    }
  }

  async createGitHubRelease() {
    const version = await this.getCurrentVersion();
    const tagName = `v${version}`;
    const releaseNotes = await this.generateReleaseNotes();
    
    // Save release notes to file
    const releaseNotesFile = path.join(this.projectRoot, 'release', 'release-notes.md');
    await fs.mkdir(path.dirname(releaseNotesFile), { recursive: true });
    await fs.writeFile(releaseNotesFile, releaseNotes);
    
    await this.log(`ðŸ“ Release notes saved to: ${releaseNotesFile}`);
    await this.log(`ðŸš€ Ready to create GitHub release: ${tagName}`);
    
    // Instructions for manual GitHub release creation
    await this.log('');
    await this.log('ðŸ“‹ Next Steps:');
    await this.log('1. Go to https://github.com/your-repo/container-gui/releases/new');
    await this.log(`2. Choose tag: ${tagName}`);
    await this.log(`3. Release title: Container GUI ${version}`);
    await this.log(`4. Copy release notes from: ${releaseNotesFile}`);
    await this.log('5. Upload release assets from: release/ directory');
    await this.log('6. Check "Set as the latest release"');
    await this.log('7. Click "Publish release"');
    
    // If GitHub CLI is available, create release automatically
    try {
      execSync('gh --version', { stdio: 'pipe' });
      
      await this.log('');
      await this.log('ðŸ¤– GitHub CLI detected, creating release automatically...');
      
      const releaseCmd = `gh release create ${tagName} --title "Container GUI ${version}" --notes-file "${releaseNotesFile}" --latest`;
      
      execSync(releaseCmd, {
        cwd: this.projectRoot,
        stdio: 'inherit'
      });
      
      // Upload release assets
      const assetsDir = path.join(this.projectRoot, 'release');
      try {
        const assets = await fs.readdir(assetsDir);
        const assetFiles = assets
          .filter(file => file.endsWith('.dmg') || file.endsWith('.zip') || file.endsWith('.sha256'))
          .map(file => path.join(assetsDir, file));
        
        if (assetFiles.length > 0) {
          const uploadCmd = `gh release upload ${tagName} ${assetFiles.join(' ')}`;
          execSync(uploadCmd, {
            cwd: this.projectRoot,
            stdio: 'inherit'
          });
          
          await this.log('âœ… Release assets uploaded');
        }
      } catch (error) {
        await this.log(`âš ï¸ Could not upload assets: ${error.message}`);
      }
      
      await this.log(`ðŸŽ‰ GitHub release created: https://github.com/your-repo/container-gui/releases/tag/${tagName}`);
      
    } catch (error) {
      await this.log('â„¹ï¸ GitHub CLI not available, manual release creation required');
    }
    
    return tagName;
  }

  async updateDocumentation() {
    await this.log('ðŸ“š Updating documentation...');
    
    const version = await this.getCurrentVersion();
    const containerVersion = await this.getLatestContainerVersion();
    
    // Update README.md with new version info
    const readmePath = path.join(this.projectRoot, 'README.md');
    
    try {
      let readme = await fs.readFile(readmePath, 'utf-8');
      
      // Update version references
      readme = readme.replace(
        /Container GUI v[\d.]+/g,
        `Container GUI v${version}`
      );
      
      // Update Apple Container CLI version references
      readme = readme.replace(
        /Apple Container CLI v[\d.]+/g,
        `Apple Container CLI ${containerVersion}`
      );
      
      await fs.writeFile(readmePath, readme);
      await this.log('âœ… README.md updated');
      
    } catch (error) {
      await this.log(`âš ï¸ Failed to update README.md: ${error.message}`);
    }
  }

  async createRelease(options = {}) {
    await this.log('ðŸš€ Starting automated release creation...');
    
    try {
      const version = await this.getCurrentVersion();
      await this.log(`ðŸ“¦ Creating release for version: ${version}`);
      
      // Build the release
      if (!options.skipBuild) {
        await this.buildRelease();
      }
      
      // Create git tag
      if (!options.skipTag) {
        await this.createGitTag();
      }
      
      // Update documentation
      await this.updateDocumentation();
      
      // Create GitHub release
      const tagName = await this.createGitHubRelease();
      
      await this.log('');
      await this.log('ðŸŽ‰ Release creation completed!');
      await this.log(`ðŸ“¦ Version: ${version}`);
      await this.log(`ðŸ·ï¸ Tag: ${tagName}`);
      await this.log(`ðŸ”— GitHub: https://github.com/your-repo/container-gui/releases/tag/${tagName}`);
      
      return {
        version,
        tagName,
        success: true
      };
      
    } catch (error) {
      await this.log(`ðŸ’¥ Release creation failed: ${error.message}`);
      throw error;
    }
  }
}

// CLI execution
if (require.main === module) {
  const options = {
    skipBuild: process.argv.includes('--skip-build'),
    skipTag: process.argv.includes('--skip-tag')
  };
  
  const creator = new ReleaseCreator();
  
  creator.createRelease(options).catch((error) => {
    console.error('Release creation failed:', error);
    process.exit(1);
  });
}

module.exports = ReleaseCreator;